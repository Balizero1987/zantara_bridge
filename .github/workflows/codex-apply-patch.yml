name: Codex Apply Patch

on:
workflow_dispatch:
inputs:
branch:
description: "Branch PR (verrÃ  creato/ricreato)"
required: true
default: "codex/update"
title:
description: "PR title"
required: true
default: "Codex update"
body:
description: "PR body (opzionale)"
required: false
default: ""
patch_b64:
description: "Base64 of unified diff"
required: true
repository_dispatch:
types: [codex-apply-patch]

permissions:
contents: write
pull-requests: write

jobs:
apply-patch:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v4
with:
fetch-depth: 0

  - name: Resolve inputs (dispatch or manual)
    id: params
    shell: bash
    run: |
      set -euo pipefail
      if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
        BRANCH="${{ github.event.client_payload.branch }}"
        TITLE="${{ github.event.client_payload.title }}"
        BODY="${{ github.event.client_payload.body }}"
        PATCH_B64="${{ github.event.client_payload.patch_b64 }}"
      else
        BRANCH="${{ inputs.branch }}"
        TITLE="${{ inputs.title }}"
        BODY="${{ inputs.body }}"
        PATCH_B64="${{ inputs.patch_b64 }}"
      fi
      echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
      echo "title=${TITLE}" >> "$GITHUB_OUTPUT"
      printf %s "${BODY}" > body.txt
      printf %s "${PATCH_B64}" | base64 -d > patch.diff

  - name: Apply patch (safe)
    shell: bash
    run: |
      set -euo pipefail
      git config user.name "github-actions[bot]"
      git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      git checkout -B "${{ steps.params.outputs.branch }}"
      git apply --whitespace=nowarn patch.diff || git apply -3 --whitespace=nowarn patch.diff
      if find . -type f -name '*.rej' -print -quit | grep -q .; then
        echo "::error::Patch rejected (.rej files present)"
        find . -type f -name '*.rej' -print
        exit 1
      fi

  - name: Create PR
    uses: peter-evans/create-pull-request@v6
    with:
      base: ${{ github.event.repository.default_branch }}
      branch: ${{ steps.params.outputs.branch }}
      title: ${{ steps.params.outputs.title }}
      body-path: body.txt
      commit-message: ${{ steps.params.outputs.title }}
      committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
      author: github-actions[bot] <41898282+git
