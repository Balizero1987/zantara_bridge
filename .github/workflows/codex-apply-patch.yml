name: Codex Apply Patch

on:
workflow_dispatch:
inputs:
branch:
description: "Branch PR (verrÃ  creato/ricreato)"
required: true
default: "codex/update"
title:
description: "PR title"
required: true
default: "Codex update"
body:
description: "PR body (opzionale)"
required: false
default: ""
patch_b64:
description: "Base64 of unified diff"
required: true

jobs:
apply:
runs-on: ubuntu-latest
permissions:
contents: write
pull-requests: write
steps:
- name: Checkout
uses: actions/checkout@v4
with:
fetch-depth: 0



- name: Decode patch
    run: echo "${{ inputs.patch_b64 }}" | base64 -d > patch.diff

- name: Apply patch (safe)
    run: |
      set -e
      git config user.name "github-actions[bot]"
      git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      git checkout -B "${{ inputs.branch }}"
      git apply --whitespace=nowarn patch.diff
      # Fail if any .rej files were produced
      if find . -name '*.rej' | grep -q .; then
        echo "::error::Patch rejected"
        find . -name '*.rej' -exec sh -c 'echo "---- {} ----"; cat "{}"' \;
        exit 1
      fi

  - name: Create PR
    uses: peter-evans/create-pull-request@v6
    with:
      branch: ${{ inputs.branch }}
      base: main
      title: ${{ inputs.title }}
      body: ${{ inputs.body || format('Automated PR by Codex Apply Patch on {0}', github.ref_name) }
      commit-message: ${{ inputs.title }}
      committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
      author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
