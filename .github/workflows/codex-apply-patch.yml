name: Codex Apply Patch
on:
  repository_dispatch:
    types: [codex-apply-patch]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-patch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Apply patch from dispatch
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.client_payload.branch }}"
          TITLE="${{ github.event.client_payload.title }}"
          BODY="${{ github.event.client_payload.body }}"
          PATCH_B64="${{ github.event.client_payload.patch_b64 }}"

          echo "Branch: $BRANCH"
          git checkout -B "$BRANCH" origin/main || git checkout -b "$BRANCH"

          PATCHFILE=/tmp/patch.diff
          printf "%s" "$PATCH_B64" | base64 -d > "$PATCHFILE"
          git apply --whitespace=fix "$PATCHFILE"

          git add -A
          git commit -m "$TITLE"
          git push -u origin "$BRANCH"

          gh pr create -t "$TITLE" -b "$BODY" -B main || true
